(function(){"use strict";var e,t,n,r,i,s;var o="codeCollectionName";Backbone.Collection.prototype.syncDirty=function(){console.log("In syncDirty");var e,t,n,r,i,s,u,a;r=localStorage.getItem(""+this[o]+"_dirty");t=r&&r.split(",")||[];a=[];var f=this;_.each(t,function(e){n=f.find(function(t){return t.dualstorage_id===e});if(!n){i=localStorage.getItem(""+f[o]+"_"+e);var t=f.create(JSON.parse(i));console.log("Not in Collection, but in localStorage; Saving to Server:",t);a.push(new_model)}else{a.push(n.save())}});return a};Backbone.Collection.prototype.syncDestroyed=function(){console.log("In syncDestroyed");var e,t,n,r,i,s,u;r=localStorage.getItem(""+this[o]+"_destroyed");t=r&&r.split(",")||[];u=[];for(i=0,s=t.length;i<s;i++){e=t[i];n=new this.model({id:e});n.collection=this;u.push(n.destroy())}return u};Backbone.Collection.prototype.syncDirtyAndDestroyed=function(){console.log("In syncDirtyAndDestroyed");this.syncDirty();return this.syncDestroyed()};e=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};window.Store=function(){function t(e){this.name=e;this.records=this.recordsOf(this.name)}t.prototype.sep="_";t.prototype.generateId=function(){return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()};t.prototype.clean=function(e,t){if(!e.dualstorage_id){e.dualstorage_id=e.get("dualstorage_id")||e.id;e.unset("dualstorage_id",{silent:true})}if(!e.dualstorage_id){console.warn("Store.clean: Still no dualstorage_id for model??",e)}var n,r;r=""+this.name+"_"+t;n=this.recordsOf(r);if(_.include(n,e.dualstorage_id)){console.log("cleaning",e.dualstorage_id);localStorage.setItem(r,_.without(n,e.dualstorage_id).join(","))}return e};t.prototype.clear=function(){var e,t,n,r;r=this.records;for(t=0,n=r.length;t<n;t++){e=r[t];localStorage.removeItem(this.name+this.sep+e)}this.records=[];return this.save()};t.prototype.create=function(e){console.log("creating",e,"in",this.name);if(!_.isObject(e)){throw new Error("Store.create: model is not an object",e);return e}if(!e.dualstorage_id){if(e.id){e.dualstorage_id=e.id;console.log("set dualstorage_id equal to id on ",e)}else{e.dualstorage_id=this.generateId();console.log("model does not have an id; generated dualstorage_id for ",e)}}if(!_.isString(e.dualstorage_id)){e.dualstorage_id=e.dualstorage_id.toString()}localStorage.setItem(this.name+this.sep+e.dualstorage_id,JSON.stringify(e));this.records.push(e.dualstorage_id);this.save();return e};t.prototype.destroy=function(e){console.log("trying to destroy",e,"in",this.name);if(!e.dualstorage_id){e.dualstorage_id=e.get("dualstorage_id")||e.id;e.unset("dualstorage_id",{silent:true})}if(!e.dualstorage_id){console.warn("Store.destroy: Still no dualstorage_id for model??",e)}localStorage.removeItem(this.name+this.sep+e.dualstorage_id);this.records=_.reject(this.records,function(t){return t===e.dualstorage_id});this.save();return e};t.prototype.destroyed=function(e){var t;t=this.recordsOf(this.name+"_destroyed");if(!_.include(t,e.dualstorage_id)){t.push(e.dualstorage_id);localStorage.setItem(this.name+"_destroyed",t.join(","))}return e};t.prototype.dirty=function(e){var t;t=this.recordsOf(this.name+"_dirty");if(!_.include(t,e.dualstorage_id)){console.log("dirtying",e);t.push(e.dualstorage_id);localStorage.setItem(this.name+"_dirty",t.join(","))}return e};t.prototype.find=function(e){console.log("finding",e,"in",this.name);return JSON.parse(localStorage.getItem(this.name+this.sep+e.dualstorage_id))};t.prototype.findAll=function(){var e,t,n,r,i;console.log("findAlling");r=this.records;i=[];for(t=0,n=r.length;t<n;t++){e=r[t];i.push(JSON.parse(localStorage.getItem(this.name+this.sep+e)))}return i};t.prototype.hasDirtyOrDestroyed=function(){return!_.isEmpty(localStorage.getItem(this.name+"_dirty"))||!_.isEmpty(localStorage.getItem(this.name+"_destroyed"))};t.prototype.recordsOf=function(e){var t;t=localStorage.getItem(e);return t&&t.split(",")||[]};t.prototype.save=function(){return localStorage.setItem(this.name,this.records.join(","))};t.prototype.update=function(e){console.log("updating",e,"in",this.name);if(!e.dualstorage_id){e.dualstorage_id=e.get("dualstorage_id")||e.id;e.unset("dualstorage_id",{silent:true})}if(!e.dualstorage_id){console.warn("Store.update: Still no dualstorage_id for model??",e)}localStorage.setItem(this.name+this.sep+e.dualstorage_id,JSON.stringify(e));if(!_.include(this.records,e.dualstorage_id)){this.records.push(e.dualstorage_id)}this.save();return e};return t}();i=function(e,t,n){var r,i;console.log("In localsync",e,t,n);i=new Store(n.storeName);r=function(){switch(e){case"read":if(t.dualstorage_id){return i.find(t)}else{return i.findAll()}break;case"hasDirtyOrDestroyed":return i.hasDirtyOrDestroyed();case"clear":return i.clear();case"create":if(!(n.add&&!n.merge&&i.find(t))){t=i.create(t);if(n.dirty){return i.dirty(t)}}break;case"update":i.update(t);if(n.dirty){return i.dirty(t)}else{return i.clean(t,"dirty")}break;case"delete":i.destroy(t);if(n.dirty){return i.destroyed(t)}else{if(t.dualstorage_id){return i.clean(t,"dirty")}else{return i.clean(t,"destroyed")}}}}();if(!n.ignoreCallbacks){if(r){n.success(r)}else{n.error("Record not found")}}return r};s=function(e,t){if(!(e&&e.parseBeforeLocalSave)){return t}if(_.isFunction(e.parseBeforeLocalSave)){return e.parseBeforeLocalSave(t)}};t=Backbone.sync;n=function(e,n,r){return(n.sync||t).call(this,e,n,r)};r=function(e,t,r){var u,a,f,l;console.log("In dualsync",e,t,r);r.storeName=_.result(t,"storeName")||_.result(t,o)||_.result(t.collection,"storeName")||_.result(t.collection,o)||"default_store";if(SERVER_CONNECTIVITY.exists()&&(_.result(t,"remote")||_.result(t.collection,"remote"))){return n(e,t,r)}a=_.result(t,"local")||_.result(t.collection,"local");r.dirty=r.remote===false&&!a;if(r.remote===false||a){return i(e,t,r)}r.ignoreCallbacks=true;l=r.success;u=r.error;switch(e){case"read":if(i("hasDirtyOrDestroyed",t,r)){console.log("can't clear",r.storeName,"require sync dirty data first");return l(i(e,t,r))}else{if(SERVER_CONNECTIVITY.exists()){r.success=function(e,n,o){var u,a,f;console.log("got remote",e,"putting into",r.storeName);e=s(t,e);if(!r.add){i("clear",t,r)}if(_.isArray(e)){for(a=0,f=e.length;a<f;a++){u=e[a];console.log("trying to store",u);i("create",u,r)}}else{i("create",e,r)}if(_.isFunction(l)){return l(e,n,o)}return true};r.error=function(n){console.log("getting local from",r.storeName);if(_.isFunction(l)){return l(i(e,t,r))}return i(e,t,r)};return n(e,t,r)}else{console.log("getting local from",r.storeName);if(_.isFunction(l)){return l(i(e,t,r))}return i(e,t,r)}}break;case"create":if(SERVER_CONNECTIVITY.exists()){r.success=function(t,n,s){i(e,t,r);if(_.isFunction(l)){return l(t,n,s)}return true};r.error=function(n){r.dirty=true;if(_.isFunction(l)){return l(i(e,t,r))}return i(e,t,r)};return n(e,t,r)}else{r.dirty=true;if(_.isFunction(l)){return l(i(e,t,r))}return i(e,t,r)}break;case"update":if(SERVER_CONNECTIVITY.exists()){if(t.dualstorage_id){f=t.clone();r.success=function(e,t,n){i("delete",f,r);i("create",e,r);if(_.isFunction(l)){return l(e,t,n)}return true};r.error=function(n){r.dirty=true;if(_.isFunction(l)){return l(i(e,t,r))}return i(e,t,r)};delete t.dualstorage_id;t.unset("dualstorage_id",{silent:true});return n("create",t,r)}else{r.success=function(n,s,o){if(_.isFunction(l)){return l(i(e,t,r))}return i(e,t,r)};r.error=function(n){r.dirty=true;if(_.isFunction(l)){return l(i(e,t,r))}return i(e,t,r)};return n(e,t,r)}}else{r.dirty=true;if(_.isFunction(l)){return l(i(e,t,r))}return i(e,t,r)}break;case"delete":if(t.dualstorage_id){return i(e,t,r)}else{if(SERVER_CONNECTIVITY.exists()){r.success=function(n,s,o){i(e,t,r);if(_.isFunction(l)){return l(n,s,o)}return true};r.error=function(n){r.dirty=true;if(_.isFunction(l)){return l(i(e,t,r))}return i(e,t,r)};return n(e,t,r)}else{r.dirty=true;if(_.isFunction(l)){return l(i(e,t,r))}return i(e,t,r)}}break}};Backbone.sync=r}).call(this)